<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥³å­å®¿èˆ</title>
    <style>
        /* --- CSS æ¨£å¼å€ (æ²¿ç”¨åŸæœ¬é¢¨æ ¼ï¼Œæ–°å¢è³¼ç‰©è»Šæ¨£å¼) --- */
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --accent: #bb86fc;
            --accent-hover: #9965f4;
            --disabled: #333333;
            --red: #cf6679;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px 20px 100px 20px; /* åº•éƒ¨ç•™ç™½çµ¦è³¼ç‰©è»Š */
        }

        h1.site-title {
            text-align: center;
            color: var(--accent);
            margin-bottom: 30px;
        }

        /* ç¶²æ ¼ç³»çµ±ï¼šè‡ªå‹•æ’ç‰ˆ */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .product-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
            transition: transform 0.2s;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .img-area {
            height: 200px;
            background-color: #2c2c2c;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
        }
        
        .img-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .info {
            padding: 15px;
        }

        .price {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent);
            float: right;
        }

        .btn-add {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: none;
            border-radius: 6px;
            background-color: #333;
            color: white;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-add:hover {
            background-color: #444;
        }

        /* é¸ä¸­ç‹€æ…‹ */
        .selected {
            border: 2px solid var(--accent);
            background-color: #2a2a2a;
        }
        
        .selected .btn-add {
            background-color: var(--accent);
            color: black;
            font-weight: bold;
        }

        /* å”®å‡ºç‹€æ…‹ */
        .sold-out {
            opacity: 0.6;
            pointer-events: none; /* ç¦æ­¢é»æ“Š */
        }
        .sold-out .img-area::after {
            content: "SOLD";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background: var(--red);
            color: white;
            padding: 5px 20px;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid white;
        }

        /* --- åº•éƒ¨è³¼ç‰©è»Š (Sticky Footer) --- */
        .cart-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #252525;
            border-top: 1px solid var(--accent);
            padding: 15px 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transform: translateY(100%); /* é è¨­éš±è— */
            transition: transform 0.3s ease-out;
            box-sizing: border-box;
            z-index: 999;
        }

        .cart-bar.active {
            transform: translateY(0);
        }

        .cart-info {
            font-size: 1.1rem;
        }
        
        .cart-total {
            color: var(--accent);
            font-weight: bold;
            font-size: 1.3rem;
            margin-left: 10px;
        }

        .btn-checkout {
            background-color: var(--accent);
            color: black;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
        }

        /* çµå¸³å½ˆçª— (Modal) */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--accent);
        }
        
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
        }

    </style>
</head>
<body>

    <h1 class="site-title">å¥³å­å®¿èˆ</h1>

    <div class="product-grid" id="product-container">
        <p style="text-align:center; width:100%;">è¼‰å…¥å•†å“ä¸­...</p>
    </div>

    <div class="cart-bar" id="cart-bar">
        <div class="cart-info">
            å·²é¸ <span id="count">0</span> ä»¶å•†å“
            <span class="cart-total">NT$ <span id="total-price">0</span></span>
        </div>
        <button class="btn-checkout" onclick="openCheckout()">å»çµå¸³ â”</button>
    </div>

    <div class="modal" id="checkout-modal">
        <div class="modal-content">
            <h2>çµå¸³ç¢ºèª</h2>
            <div id="order-summary" style="margin-bottom:15px; color:#aaa; font-size:0.9rem;"></div>
            
            <label style="font-size:0.8rem; color:#aaa;">æ”¶ä»¶äººè³‡è¨Š</label>
            <input type="text" id="buyer-name" placeholder="çœŸå¯¦å§“å (å–è²¨ç”¨)">
            <input type="tel" id="buyer-phone" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼ (æ¥æ”¶åˆ°è²¨ç°¡è¨Š)">
            <input type="email" id="buyer-email" placeholder="Email (æ¥æ”¶åŒ¯æ¬¾å¸³è™Ÿ)">
            
            <label style="font-size:0.8rem; color:#aaa; margin-top:10px; display:block;">å–è²¨é–€å¸‚</label>
            <input type="text" id="buyer-shop" placeholder="7-11 åº—åæˆ–åº—è™Ÿ (ä¾‹å¦‚ï¼šå°ä¸­é€¢ç”²åº—)">
            <button class="btn-checkout" style="width:100%; margin-top:20px;" onclick="submitOrder()" id="final-submit-btn">ç¢ºèªé€å‡º</button>
            <button style="width:100%; background:none; border:none; color:#666; margin-top:10px; cursor:pointer;" onclick="closeCheckout()">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- 1. è¨­å®šä½ çš„ GAS API ç¶²å€ ---
        // è«‹æŠŠå‰›å‰›è¤‡è£½çš„ç¶²å€è²¼åœ¨å¼•è™Ÿè£¡
        const API_URL = "https://script.google.com/macros/s/AKfycby5bfWxW-vhXNr6u0SPJQwvrkGJV8kW5kbiAmMt_lFYbRVv91oEI1rR9md6twg5oMKb_A/exec";

        // å…¨åŸŸè®Šæ•¸
        let cart = [];
        let products = []; // é€™æ¬¡æˆ‘å€‘è¨­ç‚ºç©ºé™£åˆ—ï¼Œç­‰è³‡æ–™æŠ“å›ä¾†

        // --- 2. å¾å¾Œç«¯æŠ“è³‡æ–™ (Fetch Data) ---
        async function fetchProducts() {
            const container = document.getElementById('product-container');
            container.innerHTML = '<p style="text-align:center;">æ­£åœ¨å°‹æ‰¾è¥ªå­ä¸­</p>';

            try {
                // ç™¼é€è«‹æ±‚çµ¦ GAS
                const response = await fetch(API_URL);
                const data = await response.json(); // è§£æ JSON
                
                products = data; // æŠŠæŠ“å›ä¾†çš„è³‡æ–™å­˜å…¥å…¨åŸŸè®Šæ•¸
                renderProducts(); // å‘¼å«æ¸²æŸ“å‡½å¼
            } catch (error) {
                console.error(error);
                container.innerHTML = '<p style="text-align:center; color:red;">é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
            }
        }

        // --- 3. æ¸²æŸ“å•†å“åˆ—è¡¨ (è·Ÿä¹‹å‰ä¸€æ¨£ï¼Œä½†è³‡æ–™æºè®Šäº†) ---
        function renderProducts() {
            const container = document.getElementById('product-container');
            container.innerHTML = ''; // æ¸…ç©º

            if (products.length === 0) {
                container.innerHTML = '<p style="text-align:center;">ç›®å‰æ²’æœ‰ä¸Šæ¶å•†å“</p>';
                return;
            }

            products.forEach(product => {
                // å¦‚æœ sold ç‚º trueï¼Œå°±åŠ ä¸Š sold-out æ¨£å¼
                const soldClass = product.sold ? 'sold-out' : '';
                const btnText = product.sold ? 'æ…¢äº†ä¸€æ­¥ (å·²å”®å‡º)' : 'åŠ å…¥æ¸…å–®';
                // å¦‚æœå·²å”®å‡ºï¼ŒæŒ‰éˆ•è¦ disabled (ä¸å¯é»æ“Š)
                const disabledAttr = product.sold ? 'disabled' : '';

                const html = `
                    <div class="product-card ${soldClass}" id="card-${product.id}">
                        <div class="img-area">
                            <img src="${product.img}" 
                                alt="${product.name}" 
                                referrerpolicy="no-referrer" 
                                onerror="this.src='https://via.placeholder.com/300'">
                        </div>
                        <div class="info">
                            <span class="price">$${product.price}</span>
                            <h3>${product.name}</h3>
                            <button class="btn-add" 
                                onclick="toggleCart('${product.id}', ${product.price})" 
                                ${disabledAttr}>
                                ${btnText}
                            </button>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- 4. è³¼ç‰©è»Šèˆ‡å…¶ä»–é‚è¼¯ (ç¶­æŒä¸è®Š) ---
        function toggleCart(id, price) {
            // ... (è«‹ä¿ç•™åŸæœ¬çš„ toggleCart ç¨‹å¼ç¢¼) ...
            const card = document.getElementById(`card-${id}`);
            const index = cart.indexOf(id);
            if (index === -1) {
                cart.push(id);
                card.classList.add('selected');
                card.querySelector('.btn-add').innerText = "å·²é¸æ“‡ âœ“";
            } else {
                cart.splice(index, 1);
                card.classList.remove('selected');
                card.querySelector('.btn-add').innerText = "åŠ å…¥æ¸…å–®";
            }
            updateCartUI();
        }

        function updateCartUI() {
            // ... (è«‹ä¿ç•™åŸæœ¬çš„ç¨‹å¼ç¢¼) ...
            const bar = document.getElementById('cart-bar');
            const countSpan = document.getElementById('count');
            const totalSpan = document.getElementById('total-price');
            let total = 0;
            cart.forEach(id => {
                const product = products.find(p => p.id === id);
                if(product) total += product.price;
            });
            countSpan.innerText = cart.length;
            totalSpan.innerText = total;
            if (cart.length > 0) bar.classList.add('active');
            else bar.classList.remove('active');
        }

        function openCheckout() {
            // ... (è«‹ä¿ç•™åŸæœ¬çš„ç¨‹å¼ç¢¼) ...
            const modal = document.getElementById('checkout-modal');
            const summary = document.getElementById('order-summary');
            const names = cart.map(id => products.find(p => p.id === id).name).join(', ');
            summary.innerText = `è³¼è²·é …ç›®ï¼š${names}`;
            modal.style.display = 'flex';
        }
        
        function closeCheckout() {
            document.getElementById('checkout-modal').style.display = 'none';
        }

        async function submitOrder() {
            // 1. æŠ“å–æ‰€æœ‰æ¬„ä½ DOM
            const nameInput = document.getElementById('buyer-name');
            const phoneInput = document.getElementById('buyer-phone');
            const emailInput = document.getElementById('buyer-email');
            const shopInput = document.getElementById('buyer-shop');
            const btn = document.getElementById('final-submit-btn');

            // å–å€¼
            const name = nameInput.value;
            const phone = phoneInput.value;
            const email = emailInput.value;
            const shop = shopInput.value;

            // 2. é©—è­‰å¿…å¡«
            if (!name || !phone || !email || !shop) {
                alert("è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ”¶ä»¶è³‡è¨Šï¼");
                return;
            }

            // --- 3. UI é–å®š (é˜²æ­¢é‡è¤‡é»æ“Š) ---
            // é€™å°±æ˜¯ä½ èªªæ¶ˆå¤±çš„é‚£æ®µï¼Œæˆ‘å€‘æŠŠå®ƒåŠ å›ä¾†ï¼
            const originalText = btn.innerText; // å…ˆè¨˜ä½åŸæœ¬æŒ‰éˆ•æ–‡å­—
            btn.innerText = "é€£ç·šæ¶è³¼ä¸­...";   // æ”¹è®Šæ–‡å­—
            btn.disabled = true;               // ç¦æ­¢é»æ“Š
            btn.style.cursor = "wait";         // æ¸¸æ¨™è®Šæ²™æ¼

            // 4. æ‰“åŒ…è³‡æ–™
            const payload = {
                buyer: { 
                    name: name, 
                    email: email,
                    phone: phone, 
                    shop: shop    
                },
                items: cart 
            };

            try {
                // 3. ç™¼é€ POST è«‹æ±‚ (ä½¿ç”¨ no-cors æ¨¡å¼çš„è®Šé«” text/plain)
                // ç‚ºäº†é¿å…è¤‡é›œçš„ CORS é æª¢ (Preflight)ï¼Œæˆ‘å€‘ç”¨ text/plain
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors', // ç¢ºä¿æ˜¯è·¨åŸŸè«‹æ±‚
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', 
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                // 4. è™•ç†çµæœ
                if (result.status === 'SUCCESS') {
                    alert("ğŸ‰ " + result.message);
                    // æˆåŠŸå¾Œæ¸…ç©ºè³¼ç‰©è»Šä¸¦é‡æ–°æ•´ç†
                    cart = [];
                    closeCheckout();
                    fetchProducts(); // é‡æ–°æŠ“å–åº«å­˜ï¼Œè®“å·²å”®å‡ºçš„æŒ‰éˆ•è®Šç°
                } else if (result.status === 'FAIL') {
                    if (result.failedIds && result.failedIds.length > 0) {
                        // ä½¿ç”¨ filter åŠŸèƒ½ï¼šåªç•™ä¸‹ã€Œæ²’åœ¨å¤±æ•—åå–®å…§ã€çš„å•†å“
                        // æ„æ€å°±æ˜¯ï¼šä¿ç•™é‚£äº›é‚„æœ‰è²¨çš„ï¼Œè¸¢æ‰é‚£äº›æ²’è²¨çš„
                        cart = cart.filter(itemId => !result.failedIds.includes(itemId));
                        
                        // æ›´æ–° UIï¼šæŠŠè¢«è¸¢æ‰çš„å¡ç‰‡æ¨£å¼é‚„åŸ (å–æ¶ˆç¶ è‰²é‚Šæ¡†)
                        result.failedIds.forEach(id => {
                            const card = document.getElementById(`card-${id}`);
                            if(card) {
                                card.classList.remove('selected');
                                // é€™è£¡ä¸ç”¨æ”¹æŒ‰éˆ•æ–‡å­—ï¼Œå› ç‚ºç­‰ä¸€ä¸‹ fetchProducts æœƒæŠŠå®ƒè®Šæˆã€Œå·²å”®å‡ºã€
                            }
                        });
                        
                        updateCartUI(); // æ›´æ–°åº•éƒ¨è³¼ç‰©è»Šé‡‘é¡
                    }
                    alert("ğŸ˜­ğŸ˜­ æ…¢äº†ä¸€æ­¥ï¼\n\n" + result.message + "\n\nå·²è‡ªå‹•ç‚ºæ‚¨æ›´æ–°è³¼ç‰©è»Šã€‚");
                    
                    closeCheckout(); // é—œé–‰è¦–çª—
                    fetchProducts(); // é‡æ–°æŠ“åº«å­˜ (é€™æ™‚å€™æ²’è²¨çš„é‚£é›™å°±æœƒè®Šç°äº†)
                } else {
                    alert("âš ï¸ éŒ¯èª¤ï¼š" + result.message);
                }

            } catch (err) {
                console.error(err);
                alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚");
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                btn.innerText = "ç¢ºèªé€å‡º";
                btn.disabled = false;
                btn.style.cursor = "pointer";
            }
        }

        // --- 5. å•Ÿå‹•ï¼ ---
        // ç¶²é ä¸€è¼‰å…¥ï¼Œå°±å»æŠ“è³‡æ–™
        fetchProducts();

    </script>
</body>

</html>

